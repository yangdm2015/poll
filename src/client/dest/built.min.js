/*! bae-nodejs 12-04-2017 */
!function(a,b,c){"use strict";function d(a,c,d){return{restrict:"ECA",terminal:!0,priority:400,transclude:"element",link:function(e,f,g,h,i){function j(){n&&(n.remove(),n=null),l&&(l.$destroy(),l=null),m&&(d.leave(m,function(){n=null}),n=m,m=null)}function k(){var g=a.current&&a.current.locals;if(b.isDefined(g&&g.$template)){var g=e.$new(),h=a.current;m=i(g,function(a){d.enter(a,null,m||f,function(){!b.isDefined(o)||o&&!e.$eval(o)||c()}),j()}),l=h.scope=g,l.$emit("$viewContentLoaded"),l.$eval(p)}else j()}var l,m,n,o=g.autoscroll,p=g.onload||"";e.$on("$routeChangeSuccess",k),k()}}}function e(a,b,c){return{restrict:"ECA",priority:-400,link:function(d,e){var f=c.current,g=f.locals;e.html(g.$template);var h=a(e.contents());f.controller&&(g.$scope=d,g=b(f.controller,g),f.controllerAs&&(d[f.controllerAs]=g),e.data("$ngControllerController",g),e.children().data("$ngControllerController",g)),h(d)}}}a=b.module("ngRoute",["ng"]).provider("$route",function(){function a(a,c){return b.extend(new(b.extend(function(){},{prototype:a})),c)}function c(a,b){var c=b.caseInsensitiveMatch,d={originalPath:a,regexp:a},e=d.keys=[];return a=a.replace(/([().])/g,"\\$1").replace(/(\/)?:(\w+)([\?\*])?/g,function(a,b,c,d){return a="?"===d?d:null,d="*"===d?d:null,e.push({name:c,optional:!!a}),b=b||"",""+(a?"":b)+"(?:"+(a?b:"")+(d&&"(.+?)"||"([^/]+)")+(a||"")+")"+(a||"")}).replace(/([\/$\*])/g,"\\$1"),d.regexp=RegExp("^"+a+"$",c?"i":""),d}var d={};this.when=function(a,e){if(d[a]=b.extend({reloadOnSearch:!0},e,a&&c(a,e)),a){var f="/"==a[a.length-1]?a.substr(0,a.length-1):a+"/";d[f]=b.extend({redirectTo:a},c(f,e))}return this},this.otherwise=function(a){return this.when(null,a),this},this.$get=["$rootScope","$location","$routeParams","$q","$injector","$http","$templateCache","$sce",function(c,e,f,g,h,i,j,k){function l(){var a=m(),d=p.current;a&&d&&a.$$route===d.$$route&&b.equals(a.pathParams,d.pathParams)&&!a.reloadOnSearch&&!o?(d.params=a.params,b.copy(d.params,f),c.$broadcast("$routeUpdate",d)):(a||d)&&(o=!1,c.$broadcast("$routeChangeStart",a,d),(p.current=a)&&a.redirectTo&&(b.isString(a.redirectTo)?e.path(n(a.redirectTo,a.params)).search(a.params).replace():e.url(a.redirectTo(a.pathParams,e.path(),e.search())).replace()),g.when(a).then(function(){if(a){var c,d,e=b.extend({},a.resolve);return b.forEach(e,function(a,c){e[c]=b.isString(a)?h.get(a):h.invoke(a,null,null,c)}),b.isDefined(c=a.template)?b.isFunction(c)&&(c=c(a.params)):b.isDefined(d=a.templateUrl)&&(b.isFunction(d)&&(d=d(a.params)),d=k.getTrustedResourceUrl(d),b.isDefined(d)&&(a.loadedTemplateUrl=d,c=i.get(d,{cache:j}).then(function(a){return a.data}))),b.isDefined(c)&&(e.$template=c),g.all(e)}}).then(function(e){a==p.current&&(a&&(a.locals=e,b.copy(a.params,f)),c.$broadcast("$routeChangeSuccess",a,d))},function(b){a==p.current&&c.$broadcast("$routeChangeError",a,d,b)}))}function m(){var c,f;return b.forEach(d,function(d,g){var h;if(h=!f){var i=e.path();h=d.keys;var j={};if(d.regexp)if(i=d.regexp.exec(i)){for(var k=1,l=i.length;k<l;++k){var m=h[k-1],n="string"==typeof i[k]?decodeURIComponent(i[k]):i[k];m&&n&&(j[m.name]=n)}h=j}else h=null;else h=null;h=c=h}h&&(f=a(d,{params:b.extend({},e.search(),c),pathParams:c}),f.$$route=d)}),f||d[null]&&a(d[null],{params:{},pathParams:{}})}function n(a,c){var d=[];return b.forEach((a||"").split(":"),function(a,b){if(0===b)d.push(a);else{var e=a.match(/(\w+)(.*)/),f=e[1];d.push(c[f]),d.push(e[2]||""),delete c[f]}}),d.join("")}var o=!1,p={routes:d,reload:function(){o=!0,c.$evalAsync(l)}};return c.$on("$locationChangeSuccess",l),p}]}),a.provider("$routeParams",function(){this.$get=function(){return{}}}),a.directive("ngView",d),a.directive("ngView",e),d.$inject=["$route","$anchorScroll","$animate"],e.$inject=["$compile","$controller","$route"]}(window,window.angular);var polls1=angular.module("polls",["ngRoute","ngAnimate","ngSanitize","ui.bootstrap"]);polls1.config(["$routeProvider","$locationProvider",function(a,b){b.hashPrefix(""),a.when("/polls",{templateUrl:"pages/partials/list.html",controller:"PollListCtrl",access:{restricted:!1}}).when("/mypolls",{templateUrl:"pages/partials/list.html",controller:"MyPollListCtrl",access:{restricted:!1}}).when("/myvotes",{templateUrl:"pages/partials/list.html",controller:"MyVoteListCtrl",access:{restricted:!1}}).when("/poll/:pollId",{templateUrl:"pages/partials/item.html",controller:"PollItemCtrl",access:{restricted:!1}}).when("/new",{templateUrl:"pages/partials/new.html",controller:"PollNewCtrl",access:{restricted:!1}}).when("/login",{templateUrl:"pages/partials/login.html",controller:"UserCtrl",access:{restricted:!1}}).when("/register",{templateUrl:"pages/partials/register.html",controller:"UserCtrl",access:{restricted:!1}}).otherwise({redirectTo:"/polls"})}]),polls1.run(function(a,b,c,d){a.$on("$routeChangeStart",function(a,e,f){d.getUserStatus().then(function(a){null!=e.access&&e.access.restricted&&!a.islogin&&(console.log("reload!!!!!!!!!!!!!!"),b.path("/login"),c.reload())})})}),polls1.service("messageService",["$rootScope",function(a){return{publish:function(b,c){a.$emit(b,c)},subscribe:function(b,c){a.$on(b,c)}}}]),polls1.controller("HomeCtrl",["$timeout","$scope","$location","$route","userservice",function(a,b,c,d,e){}]),polls1.controller("MyPollListCtrl",["$timeout","$scope","$location","$route","pollservice","userservice","messageService",function(a,b,c,d,e,f,g){function h(a){f.getUserStatus().then(function(b){var c=b.data,d=c.account;return d=c.user_id,e.getmypoll(d,a)}).then(function(a){b.polls=a.data}).catch(function(a){console.log(a)})}g.subscribe("query4question",function(a,b){console.log("MyVoteListCtrl",b.query),h(b.query)}),h(),b.showItemdetail=e.showItemdetail}]),polls1.controller("MyVoteListCtrl",["$timeout","$scope","$location","$route","pollservice","userservice","messageService",function(a,b,c,d,e,f,g){function h(a){f.getUserStatus().then(function(b){var c=b.data,d=c.account;return d=c.user_id,e.getmyvote(d,a)}).then(function(a){b.polls=a.data}).catch(function(a){console.log(a)})}g.subscribe("query4question",function(a,b){console.log("MyVoteListCtrl",b.query),h(b.query)}),h(),b.showItemdetail=e.showItemdetail}]),polls1.controller("PollListCtrl",["$timeout","$scope","$location","pollservice","messageService",function(a,b,c,d,e){function f(a){var b=a;for(var c in b){var d=b[c];d.img_Url=d.img_Url?d.img_Url:"routercomponent/routerimg/logo.png";var e=new Date(d.meta.updateAt);e=(e.getTime()+"").slice(0,7),d.order=e}return b}console.log("PollListCtrl"),b.showItemdetail=d.showItemdetail,e.subscribe("query4question",function(a,c){console.log(c.query),d.getallpolls(c.query).then(function(a){b.polls=f(a.data)})}),d.getallpolls().then(function(a){b.polls=f(a.data)})}]),polls1.controller("PollItemCtrl",["$scope","$routeParams","pollservice","socket","userservice","$rootScope",function(a,b,d,e,f,g){function h(a){for(var b=0,c=a.choices.length;b<c;b++){var d=a.choices[b],e=.9*(d.votes.length/a.totalVotes*100).toFixed(2)+"%";a.choices[b].choicesvotepercent=e,a.choices[b].mystyle={"background-color":"lightblue",width:e,"text-align":"left"}}}e.on("userchangeclient",function(b){a.islogin=b.islogin,a.currusername=b.account,a.poll.userVoted=i(a.poll,b.account),console.log("userchangeclient")});var i=function(a,b){for(c in a.choices){var d=a.choices[c];for(v in d.votes){var e=d.votes[v];if(e.ip===b)return!0}}return!1};d.getpoll(b.pollId).then(function(b){var c=b.data;h(c),a.poll=c,a.poll.userVote=[],console.log("poll="+a.poll),a.overvoted=!1,a.qrsrc=document.URL,a.headerstyle={"background-image":"url("+c.img_Url+")"},a.currusername=c.current_user,a.islogin=c.islogin});var j=function(b,c){if("add"==b&&a.poll.userVote.indexOf(c)==-1&&(a.poll.userVote.push(c),a.poll.max_chosen_num<a.poll.userVote.length&&(a.overvoted=!0)),"remove"==b&&a.poll.userVote.indexOf(c)!=-1){var d=a.poll.userVote.indexOf(c);a.poll.userVote.splice(d,1),a.poll.max_chosen_num>=a.poll.userVote.length&&(a.overvoted=!1)}},k=function(b,c,d){"add"==b&&a.poll.userVote.indexOf(c)==-1&&(a.poll.userVote.pop(),a.poll.userVote.push(c),d.className=d.className+" choicewrapactive"),"remove"==b&&a.poll.userVote.indexOf(c)!=-1&&(a.poll.userVote.pop(),d.className=d.className.split("choicewrapactive")[0].split(" ")[0])};a.updateSelection=function(b,c){var d=b.target,e=d.checked?"add":"remove";a.poll.allow_muti_choice?j(e,c):k(e,c,b.currentTarget)},a.vote=function(){console.log("PollItemCtrl.vote"),f.getUserStatus().then(function(b){var c=b.data;if(c.islogin){var d=a.poll._id,f=a.poll.allow_muti_choice?a.poll.userVote:[a.poll.nobodycares];if(useraccount=c.user_id,poll=a.poll,poll.userVote.length<=poll.max_chosen_num)if(f){var g={poll_id:d,choices:f,useraccount:useraccount};e.emit("send:vote",g)}else alert("You must select an option to vote for.你必须至少选择一项。");else alert("You can vote for no more than "+poll.max_chosen_num+" options.你最多只能选择 "+poll.max_chosen_num+" 个选项")}else alert("You must login before voting.你必须登陆才能投票。")})},e.on("vote",function(c){c._id===b.pollId&&(h(c),a.poll.choices=c.choices,a.poll.totalVotes=c.totalVotes,a.poll.totalVotedpeople=c.totalVotedpeople,a.poll.userVoted=!0,a.poll.userChoice=c.userChoice)})}]),polls1.controller("PollNewCtrl",["$scope","$location","userservice","pollservice","socket","$q",function(a,b,c,d,e,f){console.log("PollNewCtrl"),c.getUserStatus().then(function(b){var c=b.data;a.currusername=c.account,a.islogin=c.islogin,a.theme_pic_location=d.getthemepic(),a.poll={question:"",max_chosen_num:1,allow_muti_choice:!1,allow_img_choice:!0,test:!1,choices:[{text:""},{text:""}],choicefileread:[{srcnode:"#choice_img_0"},{srcnode:"#choice_img_1"}]}}).catch(function(a){console.log(a)}),e.on("userchangeclient",function(b){a.islogin=b.islogin,a.currusername=b.account,console.log("userchangeclient")}),a.addChoice=function(){a.poll.choices.push({text:""}),a.choicenum.push(a.poll.choices.length)},a.popChoice=function(){a.poll.choices.pop(),a.choicenum.pop()},a.fileread={srcnode:"#output",imgsrc:"",file:"",target:"#output"},a.createPoll=function(){console.log("createPoll");var e=f.defer();c.getUserStatus().then(function(b){var c=b.data,f=a.fileread.file?a.fileread.file:a.theme_pic_location,g=a.poll;if(g.created_user=c.user_id,g.allow_img_choice)for(var h=0,i=g.choices.length;h<i;h++){var j=g.choices[h];j.file||e.reject("Please upload images! 请上传选项的图片！")}return d.savepoll(g,f)}).then(function(a){console.log("result=",a),b.path("polls")}).catch(function(a){alert(a),console.log(a)})}}]).directive("filefrominput",function(){return{replace:!0,scope:{fileread:"="},template:'<input id="in" type="file" ng-hide=true >',link:function(a,b,c){var d=document.querySelector(a.fileread.srcnode);d&&(d.onclick=function(){b[0].click()}),b.bind("change",function(c){function d(a,b){var c=new FileReader;c.onload=function(a){b.$apply(function(){if(b.fileread.imgsrc=a.target.result,b.fileread.target){var c=document.querySelector(b.fileread.target);c.src=b.fileread.imgsrc}})},c.readAsDataURL(a.target.files[0])}a.fileread.file=b[0].files[0],d(c,a)})}}}).directive("multiimgup",function(){function a(a,b,c){a.name="Jeff";var d=b.find("img")[0],e=b.find("span"),f=b.find("input")[0];b.children()[0].onclick=function(a){f.click()},b.bind("change",function(b){function g(a){var b=new FileReader;b.onload=function(b){a.src=b.target.result},b.readAsDataURL(f.files[0])}var h=f.files[0];a.c[c.idx].file=h,h&&(e.css("display","none"),g(d))})}return{link:a,transclude:!0,scope:{index:"@idx",c:"=chos"},templateUrl:"pages/templates/choiceimg.html"}}),polls1.controller("ModalHeaderCtrl",["userservice","$uibModal","$rootScope","socket","messageService",function(a,b,c,d,e){var f=this;f.animationsEnabled=!0,a.getUserStatus().then(function(a){var b=a.data;b.status?(f.islogin=!0,f.curraccount=b.account):f.islogin=!1}),f.select=function(){e.publish("query4question",{query:f.query})},f.logout=function(){a.signout().then(function(a){var b=a.data;b.status&&(f.islogin=!1,f.currusername="")})},f.loginmodalopen=function(){var a=b.open({animation:f.animationsEnabled,templateUrl:"LoginModalContent",controller:"LoginModalInstanceCtrl",controllerAs:"$ctrl"});a.result.then(function(a){d.emit("userchange",{islogin:!0,account:a}),f.islogin=!0,f.curraccount=a},function(){console.log("Modal dismissed at: "+new Date)})},f.registermodalopen=function(){var a=b.open({animation:f.animationsEnabled,templateUrl:"registerModalContent",controller:"registerModalInstanceCtrl",controllerAs:"$ctrl"});a.result.then(function(a){f.islogin=!0,f.curraccount=a},function(){console.log("Modal dismissed at: "+new Date)})}}]),polls1.controller("registerModalInstanceCtrl",["$uibModalInstance","userservice","$q",function(a,b,c){var d=this;d.autologin=!0,d.alerts=[],d.addAlert=function(a){d.alerts.push({msg:a})},d.closeAlert=function(a){d.alerts.splice(a,1)},d.ok=function(){b.signup({account:d.account,password:d.password}).then(function(a){var e=c.defer(),f=e.promise,g=a.data;if("ok"==g.status){if(d.autologin)return b.signin({account:d.account,password:d.password});e.reject("tologin")}else"exist"==g.status&&e.reject("exist");return f}).then(function(b){var c=b.data;"ok"==c.status?a.close(d.account):"wrongpass"==c.status?d.addAlert("Invalid username and/or password. 用户名/密码不对"):"notexist"==c.status&&d.addAlert("User "+d.account+" does not exist. 用户"+d.account+"不存在")}).catch(function(b){"tologin"==b?a.dismiss("cancel"):d.addAlert('User "'+d.account+'" alrady exist! 用户 '+d.account+" 已存在"),console.log(b)})},d.cancel=function(){a.dismiss("cancel")}}]),polls1.controller("LoginModalInstanceCtrl",["$uibModalInstance","userservice",function(a,b){var c=this;c.alerts=[],c.addAlert=function(a){c.alerts.push({msg:a})},c.closeAlert=function(a){c.alerts.splice(a,1)},c.ok=function(){b.signin({account:c.account,password:c.password}).then(function(b){var d=b.data;"ok"==d.status?a.close(c.account):"wrongpass"==d.status?c.addAlert("Invalid username and/or password. 用户名/密码不对"):"notexist"==d.status&&c.addAlert("User "+c.account+" does not exist. 用户"+c.account+"不存在")}).catch(function(a){console.log(a)})},c.cancel=function(){a.dismiss("cancel")}}]),polls1.controller("AlertDemoCtrl",function(a){}),polls1.factory("userservice",["$q","$http","socket","$location",function(a,b,c,d){function e(a){var b=new FormData;for(var c in a)b.append(c,a[c]);return b}var f={islogin:!1,account:""},g=function(){return f},h=function(a){f=a},i=function(){var c=a.defer(),d=c.promise;return b.get("/user/status").then(function(a){var b=a.data;b.status&&h({islogin:b.islogin,account:b.account,user:b.user}),c.resolve(a)}).catch(function(a){c.reject(a)}),d},j=function(){var c=a.defer(),d=c.promise;return b.get("/user/statusfromdb").then(function(a){var b=a.data;b.status&&h({islogin:b.islogin,account:b.account,user:b.user}),c.resolve(a)}).catch(function(a){c.reject(a)}),d},k=function(c){var d=e(c),f=a.defer(),g=f.promise,h={method:"post",url:"/user/update",data:d,headers:{"Content-Type":void 0}};return b(h).then(function(a){f.resolve(a)}),g},l=function(c){var e=a.defer(),f=e.promise,g={method:"post",url:"/user/login",data:{user:c}};console.log("$location=",d);d.$$path.split("/")[2];return b(g).then(function(a){e.resolve(a)}),f},m=function(c){var d=a.defer(),e=d.promise,f={method:"post",url:"/user/register",data:{user:c}};return b(f).then(function(a){d.resolve(a)}),e},n=function(){var c=a.defer(),d=c.promise;return b.get("/user/logout").then(function(a){a.status?(f.islogin=!1,f.account="",c.resolve(a)):c.resolve(a)}).catch(function(a){c.reject()}),d},o=function(c){var d=a.defer(),e=d.promise,f={method:"get",url:"/user/setmsgreaded",params:{index:c}};return b(f).then(function(a){d.resolve(a)}),e},p=function(c,d){var e=a.defer(),f=e.promise,g={method:"get",url:"/user/addtomyfavor",params:{pollid:c,url:d}};return b(g).then(function(a){e.resolve(a)}),f},q=function(c){var d=a.defer(),e=d.promise,f={method:"get",url:"/user/deletefrommyfavor",params:{pollid:c}};return b(f).then(function(a){d.resolve(a)}),e};return{updateuser:k,setUserStatussync:h,getUserStatussync:g,signout:n,signup:m,signin:l,getUserStatus:i,getUserstatusfromdb:j,setmsgreaded:o,addtomyfavor:p,deletefrommyfavor:q}}]),polls1.factory("pollservice",["$q","$http",function(a,b){function c(a,b){var c=new FormData,d=a.allow_img_choice;return angular.forEach(a,function(a,b){if("choices"==b){if(d)for(var e=0,f=a.length;e<f;e++){var g=a[e].file;c.append("poll_theme",g)}c.append(b,JSON.stringify(a))}else c.append(b,a)}),"string"==typeof b?c.append("poll_theme_url",b):c.append("poll_theme",b),c}var d=function(c,d){var e=a.defer(),f=e.promise;console.log("query=",c);var g="/polls/polls";return b({url:g,method:"GET",params:{query:c,page:d}}).then(function(a){e.resolve(a)}).catch(function(a){e.reject(a)}),f},e=function(c,d,e){var f=a.defer(),g=f.promise;if(c){var h="/mypolls/"+c;b({url:h,method:"GET",params:{query:d,page:e}}).then(function(a){console.log("in getmypoll, return data=",a),f.resolve(a)}).catch(function(a){f.reject(a)})}else f.reject("Please login first!");return g},f=function(c,d,e){var f=a.defer(),g=f.promise;if(c){var h="/myvotes/"+c;b({url:h,method:"GET",params:{query:d,page:e}}).then(function(a){f.resolve(a)}).catch(function(a){f.reject(a)})}else f.reject("Please login first!");return g},g=function(c){var d=a.defer(),e=d.promise;return b.get("/polls/"+c).then(function(a){d.resolve(a)}).catch(function(a){d.reject(a)}),e},h=function(d,e){var f=a.defer(),g=f.promise;if(d.question.length>0){for(var h=0,i=0,j=d.choices.length;i<j;i++){var k=d.choices[i];k.text.length>0&&h++}if(h>1){var l=c(d,e),m={method:"post",url:"polls",data:l,headers:{"Content-Type":void 0},transformRequest:angular.identity};b(m).then(function(a){console.log("save successful"),f.resolve(a)}).catch(function(a){f.reject(a),alert("暂时不能创建投票，请稍后再试")})}else alert("你必须至少填写两个选项！")}else alert("你必须填写投票主题！");return g},i=function(){var a="pollcomponent/theme_pic/"+Math.floor(21*Math.random()+1)+".jpg";return a},j=function(){var a="pollcomponent/head_pic/"+Math.floor(24*Math.random()+1)+".jpg";return a},k=function(a){function b(a,b){return a-b}function c(a,b){return b.order-a.order}var d=a,e=[];for(var f in d){var g=d[f];g.img_Url=g.img_Url?g.img_Url:"routercomponent/routerimg/logo.png";var h=new Date(g.meta.updateAt);h=(h.getTime()+"").slice(0,10),g.order=h,e.push(h)}e=e.sort(b);for(var f in d){var g=d[f];g.order=e.indexOf(g.order)}return d.sort(c),d},l=function(a){return window.location.href="#/poll/"+a,!1};return{getheadpic:j,showItemdetail:l,genorder:k,getthemepic:i,getmypoll:e,getmyvote:f,getpoll:g,getallpolls:d,savepoll:h}}]).factory("socket",["$rootScope","$timeout",function(a,b){var c=io.connect();return{on:function(a,d){c.on(a,function(){var a=arguments;b(function(){d.apply(c,a)},0)})},emit:function(a,d,e){c.emit(a,d,function(){var a=arguments;b(function(){e&&e.apply(c,a)},0)})}}}]),polls1.service("commentservice",["$q","$http",function(a,b){var c=function(c){var d=a.defer(),e=d.promise,f="/comment/create";return b({url:f,method:"post",data:{comment:c}}).then(function(a){d.resolve(a)}).catch(function(a){d.reject(a)}),e},d=function(c){var d=a.defer(),e=d.promise,f="/comment/getbytouserid";return b({url:f,method:"post",data:{touserid:c}}).then(function(a){d.resolve(a)}).catch(function(a){d.reject(a)}),e},e=function(c){var d=a.defer(),e=d.promise,f="/user/deleteusercomment";return b({url:f,method:"post",data:{commentindex:c}}).then(function(a){d.resolve(a)}).catch(function(a){d.reject(a)}),e},f=function(c){var d=a.defer(),e=d.promise,f="/comment/test";return b({url:f,method:"post",data:{name:c}}).then(function(a){d.resolve(a)}).catch(function(a){d.reject(a)}),e};return{deleteusercomment:e,testsockit:f,getcommentbytouser:d,savecomment:c}}]);