/*! bae-nodejs 22-04-2017 */
var polls1=angular.module("polls",["ngRoute","mobile-angular-ui","mobile-angular-ui.gestures","ngTouch"]);polls1.config(["$routeProvider",function(a){a.when("/",{templateUrl:"pages/mobile/polllist.html",reloadOnSearch:!1,controller:"PolllistController"}),a.when("/polllist",{templateUrl:"pages/mobile/polllist.html",reloadOnSearch:!1,controller:"PolllistController"}),a.when("/myvotelist",{templateUrl:"pages/mobile/myvotelist.html",reloadOnSearch:!1,controller:"MyVoteController"}),a.when("/mypollslist",{templateUrl:"pages/mobile/mypollslist.html",reloadOnSearch:!1,controller:"MyPollsController"}),a.when("/poll/:pollId",{templateUrl:"pages/mobile/mbpollitem.html",reloadOnSearch:!1,controller:"PollItemCtrl"}),a.when("/new",{templateUrl:"pages/mobile/new.html",reloadOnSearch:!1,controller:"Pollnewcontroller"}),a.when("/usermg",{templateUrl:"pages/mobile/usermanagement.html",reloadOnSearch:!1}),a.when("/mymsgs",{templateUrl:"pages/mobile/drapscroll.html",reloadOnSearch:!1,controller:"msgController"}),a.when("/myfavor",{templateUrl:"pages/mobile/mycollection.html",reloadOnSearch:!1,controller:"myfavorcontroller"})}]),polls1.controller("HomeCtrl",["userservice","pollservice","$rootScope","$scope","messageService","SharedState","$anchorScroll","$location","$window","$document","$drag",function(a,b,c,d,e,f,g,h,i,j,k){$hctrl=this,d.goback=function(){history.back()},$hctrl.gotop=function(){h.hash("abtop"),g()},$hctrl.togglefloatmenu=function(a){var b=!a;$hctrl.fm=b},d.gobaktotop=function(){h.hash("abtop"),g()},d.islogin=!1,e.subscribe("navbarbtnchange",function(a,b){f.setOne("navbarbtn",b.navbarbtn)}),d.swiped=function(a){alert("Swiped "+a)},d.userAgent=navigator.userAgent,c.$on("$routeChangeStart",function(){c.loading=!0}),c.$on("$routeChangeSuccess",function(){c.loading=!1})}]),polls1.controller("PollItemCtrl",["userservice","pollservice","$scope","messageService","$routeParams","socket","commentservice","SharedState","$location","$anchorScroll","$window",function(a,b,c,d,e,f,g,h,i,j,k){function l(a,b){for(var c=0,d=a.length;c<d;c++){var e=a[c];if(e._id==b._id){a.splice(c,1,b);break}}}function m(){d.subscribe("userlogin",function(a,b){c.islogin=b.islogin,c.account=b.account,n()}),d.subscribe("userupdate",function(a,b){c.user=b.user}),c.qrsrc=document.URL,a.getUserStatus().then(function(a){return c.islogin=a.data.islogin,c.account=a.data.account,c.user=a.data.user,c.user}).then(function(a){n()}),c.commentshow=!0}function n(){b.getpoll(e.pollId).then(function(a){var b=a.data;p(b),c.poll=b,c.user?c.favor=o(c.user.favor,b._id):c.favor=!1,c.poll.userVote=[],console.log("poll="+c.poll),c.overvoted=!1,c.headerstyle={"background-image":"url("+b.img_Url+")"},c.currusername=b.current_user,c.islogin=b.islogin}).catch(function(a){console.log(a)})}function o(a,b){if(a instanceof Array&&a.length>0)for(var c=0,d=a.length;c<d;c++){var e=a[c];if(b.toString()==e.poll)return!0}return!1}function p(a){for(var b=0,c=a.choices.length;b<c;b++){var d=a.choices[b],e=.9*(d.votes.length/a.totalVotes*100).toFixed(2)+"%";a.choices[b].choicesvotepercent=e,a.choices[b].mystyle={"background-color":"lightblue",width:e,"text-align":"left"}}}c.gotop=function(){i.hash("abtop"),j()},c.anchor=function(){j.yOffset=150,i.hash("58e740b1448e9040ac5fcf86"),j()},c.addtomyfavor=function(){if(console.log(c.favor),c.user)if(c.favor)a.deletefrommyfavor(c.poll._id).then(function(a){d.publish("userupdate",{user:a.data}),c.favor=!1,c.user=a.data});else{var b=i.url();a.addtomyfavor(c.poll._id,b).then(function(a){console.log("添加用户收藏成功"),d.publish("userupdate",{user:a.data}),c.favor=!0,c.user=a.data,console.log("添加用户收藏成功，user=",a.data)})}},c.vote=function(){console.log("PollItemCtrl.vote"),a.getUserStatus().then(function(a){var b=a.data;if(b.islogin){var d=c.poll._id,e=c.poll.allow_muti_choice?c.poll.userVote:[c.poll.nobodycares],g=b.account,g=b.user_id,h=c.poll;if(h.userVote.length<=h.max_chosen_num)if(e.length>0){var i={poll_id:d,choices:e,useraccount:g};f.emit("send:vote",i)}else alert("You must select an option to vote for.你必须至少选择一项。");else alert("You can vote for no more than "+h.max_chosen_num+" options.你最多只能选择 "+h.max_chosen_num+" 个选项")}else alert("You must login before voting.你必须登陆才能投票。")})},c.createcomment=function(){a.getUserStatus().then(function(a){var b=a.data.user_id;return c.curreplayto?g.savecomment({from:b,content:c.curcomment,to:c.curreplayto,incomment:c.curcomid,tocreateuser:c.poll.created_user,aburl:i.absUrl()}):g.savecomment({from:b,content:c.curcomment,poll:c.poll._id,tocreateuser:c.poll.created_user,aburl:i.absUrl()})}).then(function(a){var b=a.data.comment;a.data.user;c.curreplayto?(c.curreplayto="",c.curcomid="",l(c.poll.comments,b)):c.poll.comments.push(b),c.curcomment="",console.log(b)}).catch(function(a){console.log(a)})},c.replytocomment=function(a,b,d){c.curreplayto=a,c.curcomid=d._id,c.curcomment_ph="回复 "+b+":",angular.element(document).find("textarea")[0].focus()},c.toggle_c_show=function(){c.commentshow=1!=c.commentshow},f.on("vote",function(a){a._id===e.pollId&&(p(a),c.poll.choices=a.choices,c.poll.totalVotes=a.totalVotes,c.poll.totalVotedpeople=a.totalVotedpeople,c.poll.userVoted=!0,c.poll.userChoice=a.userChoice,d.publish("userupdate",{user:a.user}))}),c.updateSelection=function(a,b){var d=c.poll.allow_muti_choice;if(d){var e=a.currentTarget.getElementsByTagName("input")[1];e.checked=!e.checked;var f=e.checked?"add":"remove";console.log("checkbox DETECTED!，action=",f),s(f,b,a.currentTarget)}},c.updateRadio=function(a){console.log(a);var b,d;c.poll.allow_img_choice?(b=document.querySelectorAll('.choicewrap[name="'+a+'"]')[1],d=document.querySelectorAll(".choicewrap[ng-show]")):(b=document.querySelectorAll('.choicewrap[name="'+a+'"]')[0],d=document.querySelectorAll(".choicewrap[ng-hide]"));for(var e=0,f=d.length;e<f;e++)r(d[e],"choicewrapactive");q(b,"choicewrapactive")};var q=function(a,b){a.className.indexOf(b)<0&&(a.className=a.className+" "+b)},r=function(a,b){if(a.className.indexOf(b)>0){var c=new RegExp(b,"gm");a.className=a.className.replace(c,"").replace(/\s+/gm," ").replace(/\s$/,"")}};m();var s=function(a,b,d){if("add"==a&&c.poll.userVote.indexOf(b)==-1&&(c.poll.userVote.push(b),d.className=d.className+" choicewrapactive",c.poll.max_chosen_num<c.poll.userVote.length&&(c.overvoted=!0)),"remove"==a&&c.poll.userVote.indexOf(b)!=-1){var e=c.poll.userVote.indexOf(b);c.poll.userVote.splice(e,1),d.className=d.className.split("choicewrapactive")[0].split(" ")[0],c.poll.max_chosen_num>=c.poll.userVote.length&&(c.overvoted=!1)}}}]),polls1.controller("MyVoteController",["userservice","pollservice","$scope","messageService","$rootScope","SharedState",function(a,b,c,d,e,f){function g(d){e.loading=!0,c.polls=[],a.getUserStatus().then(function(a){var c=(a.data.account,a.data.user_id);return b.getmyvote(c,d,h)}).then(function(a){c.polls=b.genorder(a.data),e.loading=!1}).catch(function(a){console.log(a),e.loading=!1})}c.qrsrc=document.URL,d.publish("navbarbtnchange",{navbarbtn:3});var h=1,i=!1,j=15;c.iarrow=[],c.bottomReached=function(){e.loading=!0,h=Math.floor(c.polls.length/10)+1,i?e.loading=!1:a.getUserStatus().then(function(a){var d=a.data.account;return b.getmyvote(d,c.query,h)}).then(function(a){i=a.data.length<j,c.polls=b.genorder(c.polls.concat(a.data)),e.loading=!1})},c.toggle=function(a){console.log("SharedState.get('myAccordion')=",f.get("myAccordion")),console.log("order=",a),f.get("myAccordion")==a?(f.setOne("myAccordion",-1),console.log("after,SharedState.get('myAccordion')=",f.get("myAccordion")),c.iarrow[a]=!1):(c.iarrow[a]=!0,f.setOne("myAccordion",a))},c.queryquestion=function(){h=1,g(c.query)},g(),d.subscribe("userlogin",function(a,b){c.islogin=b.islogin,c.account=b.account,g(b.query)}),c.showItemdetail=b.showItemdetail}]),polls1.controller("MyPollsController",["userservice","pollservice","$scope","messageService","$rootScope","SharedState",function(a,b,c,d,e,f){function g(d){e.loading=!0,c.polls=[],a.getUserStatus().then(function(a){var c=(a.data.account,a.data.user_id);return b.getmypoll(c,d,h)}).then(function(a){c.polls=b.genorder(a.data),e.loading=!1}).catch(function(a){e.loading=!1,console.log(a)})}c.qrsrc=document.URL,d.publish("navbarbtnchange",{navbarbtn:4});var h=1,i=!1,j=15;c.iarrow=[],c.bottomReached=function(){e.loading=!0,h=Math.floor(c.polls.length/10)+1,i?e.loading=!1:a.getUserStatus().then(function(a){var d=a.data.account;return b.getmypoll(d,c.query,h)}).then(function(a){i=a.data.length<j,c.polls=b.genorder(c.polls.concat(a.data)),e.loading=!1}).catch(function(a){console.log(a),e.loading=!1})},c.toggle=function(a){console.log("SharedState.get('myAccordion')=",f.get("myAccordion")),console.log("order=",a),f.get("myAccordion")==a?(f.setOne("myAccordion",-1),console.log("after,SharedState.get('myAccordion')=",f.get("myAccordion")),c.iarrow[a]=!1):(c.iarrow[a]=!0,f.setOne("myAccordion",a))},c.queryquestion=function(){h=1,g(c.query)},g(),c.showItemdetail=b.showItemdetail}]),polls1.controller("PolllistController",["userservice","pollservice","$rootScope","$scope","messageService","SharedState",function(a,b,c,d,e,f){function g(){d.qrsrc=document.URL,c.loading=!0,d.uiif=[],a.getUserStatussync().islogin?(d.islogin=!0,d.account=a.getUserStatussync().account):a.getUserStatus().then(function(a){d.islogin=a.data.islogin,d.account=a.data.account}),h(),e.publish("navbarbtnchange",{navbarbtn:1}),c.loading=!1}function h(a){c.loading=!0,b.getallpolls(a,j).then(function(a){a.data&&a.data.length>0&&(d.polls=b.genorder(a.data)),c.loading=!1})}function i(a){for(var b=[!1,!1,!1,!1,!1,!1,!1,!1],c=8;c<a;)b=b.concat(b),c=b.length;return b.slice(0,a)}d.showItemdetail=b.showItemdetail;var j=1,k=!1,l=15;d.iarrow=[],d.bottomReached=function(){c.loading=!0,j=Math.floor(d.polls.length/10)+1,k?c.loading=!1:b.getallpolls(d.query,j).then(function(a){k=a.data.length<l;var e=b.genorder(d.polls.concat(a.data));d.iarrow=i(e.length),d.polls=e,c.loading=!1})},d.toggle=function(a){console.log("SharedState.get('myAccordion')=",f.get("myAccordion")),console.log("order=",a),f.get("myAccordion")==a?(f.setOne("myAccordion",-1),console.log("after,SharedState.get('myAccordion')=",f.get("myAccordion")),d.iarrow[a]=!1):(d.iarrow[a]=!0,f.setOne("myAccordion",a))},g(),d.queryquestion=function(){j=1,h(d.query)},e.subscribe("userlogin",function(a,b){d.islogin=b.islogin,d.account=b.account})}]),polls1.controller("Pollnewcontroller",["userservice","pollservice","$scope","messageService","$routeParams","socket","$q","$location",function(a,b,c,d,e,f,g,h){function i(){a.getUserStatus().then(function(a){var d=a.data;c.currusername=d.account,c.islogin=d.islogin,c.theme_pic_location=b.getthemepic(),c.poll={question:"",max_chosen_num:1,allow_muti_choice:!1,allow_img_choice:!0,test:!1,choices:[{text:""},{text:""}],choicefileread:[{srcnode:"#choice_img_0"},{srcnode:"#choice_img_1"}]}}).catch(function(a){console.log(a)}),d.subscribe("userlogin",function(a,b){c.islogin=b.islogin,c.account=b.account})}console.log("PollNewCtrl"),d.publish("navbarbtnchange",{navbarbtn:2}),c.changeimgurl=function(){c.theme_pic_location=b.getthemepic()},i(),c.addChoice=function(){c.poll.choices.push({text:""}),c.choicenum.push(c.poll.choices.length)},c.popChoice=function(){c.poll.choices.pop(),c.choicenum.pop()},c.fileread={srcnode:"#output",imgsrc:"",file:"",target:"#output"},c.createPoll=function(){console.log("createPoll");var e,f=g.defer();a.getUserStatus().then(function(a){var d=a.data;e=d.user;var g=c.fileread.file?c.fileread.file:c.theme_pic_location,h=c.poll;if(h.created_user=d.user_id,h.allow_img_choice)for(var i=0,j=h.choices.length;i<j;i++){var k=h.choices[i];k.file||f.reject("Please upload images! 请上传选项的图片！")}return b.savepoll(h,g)}).then(function(a){d.publish("userupdate",{user:e}),console.log("result=",a);var b=a.data._id;h.path("poll/"+b)}).catch(function(a){alert(a),console.log(a)})},c.test=function(){console.log("test!!s")}}]),polls1.factory("pollservice",["$q","$http",function(a,b){function c(a,b){var c=new FormData,d=a.allow_img_choice;return angular.forEach(a,function(a,b){if("choices"==b){if(d)for(var e=0,f=a.length;e<f;e++){var g=a[e].file;c.append("poll_theme",g)}c.append(b,JSON.stringify(a))}else c.append(b,a)}),"string"==typeof b?c.append("poll_theme_url",b):c.append("poll_theme",b),c}var d=function(c,d){var e=a.defer(),f=e.promise;console.log("query=",c);var g="/polls/polls";return b({url:g,method:"GET",params:{query:c,page:d}}).then(function(a){e.resolve(a)}).catch(function(a){e.reject(a)}),f},e=function(c,d,e){var f=a.defer(),g=f.promise;if(c){var h="/mypolls/"+c;b({url:h,method:"GET",params:{query:d,page:e}}).then(function(a){console.log("in getmypoll, return data=",a),f.resolve(a)}).catch(function(a){f.reject(a)})}else f.reject("Please login first!");return g},f=function(c,d,e){var f=a.defer(),g=f.promise;if(c){var h="/myvotes/"+c;b({url:h,method:"GET",params:{query:d,page:e}}).then(function(a){f.resolve(a)}).catch(function(a){f.reject(a)})}else f.reject("Please login first!");return g},g=function(c){var d=a.defer(),e=d.promise;return b.get("/polls/"+c).then(function(a){d.resolve(a)}).catch(function(a){d.reject(a)}),e},h=function(d,e){var f=a.defer(),g=f.promise;if(d.question.length>0){for(var h=0,i=0,j=d.choices.length;i<j;i++){var k=d.choices[i];k.text.length>0&&h++}if(h>1){var l=c(d,e),m={method:"post",url:"polls",data:l,headers:{"Content-Type":void 0},transformRequest:angular.identity};b(m).then(function(a){console.log("save successful"),f.resolve(a)}).catch(function(a){f.reject(a),alert("暂时不能创建投票，请稍后再试")})}else alert("你必须至少填写两个选项！")}else alert("你必须填写投票主题！");return g},i=function(){var a="pollcomponent/theme_pic/"+Math.floor(21*Math.random()+1)+".jpg";return a},j=function(){var a="pollcomponent/head_pic/"+Math.floor(24*Math.random()+1)+".jpg";return a},k=function(a){function b(a,b){return a-b}function c(a,b){return b.order-a.order}var d=a,e=[];for(var f in d){var g=d[f];g.img_Url=g.img_Url?g.img_Url:"routercomponent/routerimg/logo.png";var h=new Date(g.meta.updateAt);h=(h.getTime()+"").slice(0,10),g.order=h,e.push(h)}e=e.sort(b);for(var f in d){var g=d[f];g.order=e.indexOf(g.order)}return d.sort(c),d},l=function(a){return window.location.href="#/poll/"+a,!1},m=!1,n=function(){return m||(m=!0),m},o=function(a){m=a};return{getalreadyloaded:n,setalreadyloaded:o,getheadpic:j,showItemdetail:l,genorder:k,getthemepic:i,getmypoll:e,getmyvote:f,getpoll:g,getallpolls:d,savepoll:h}}]).factory("socket",["$rootScope","$timeout",function(a,b){var c=io.connect();return{on:function(a,d){c.on(a,function(){var a=arguments;b(function(){d.apply(c,a)},0)})},emit:function(a,d,e){c.emit(a,d,function(){var a=arguments;b(function(){e&&e.apply(c,a)},0)})}}}]),polls1.service("commentservice",["$q","$http",function(a,b){var c=function(c){var d=a.defer(),e=d.promise,f="/comment/create";return b({url:f,method:"post",data:{comment:c}}).then(function(a){d.resolve(a)}).catch(function(a){d.reject(a)}),e},d=function(c){var d=a.defer(),e=d.promise,f="/comment/getbytouserid";return b({url:f,method:"post",data:{touserid:c}}).then(function(a){d.resolve(a)}).catch(function(a){d.reject(a)}),e},e=function(c){var d=a.defer(),e=d.promise,f="/user/deleteusercomment";return b({url:f,method:"post",data:{commentindex:c}}).then(function(a){d.resolve(a)}).catch(function(a){d.reject(a)}),e},f=function(c){var d=a.defer(),e=d.promise,f="/comment/test";return b({url:f,method:"post",data:{name:c}}).then(function(a){d.resolve(a)}).catch(function(a){d.reject(a)}),e};return{deleteusercomment:e,testsockit:f,getcommentbytouser:d,savecomment:c}}]),polls1.factory("userservice",["$q","$http","socket","$location",function(a,b,c,d){function e(a){var b=new FormData;for(var c in a)b.append(c,a[c]);return b}var f={islogin:!1,account:""},g=function(){return f},h=function(a){f=a},i=function(){var c=a.defer(),d=c.promise;return b.get("/user/status").then(function(a){var b=a.data;b.status&&h({islogin:b.islogin,account:b.account,user:b.user}),c.resolve(a)}).catch(function(a){c.reject(a)}),d},j=function(){var c=a.defer(),d=c.promise;return b.get("/user/statusfromdb").then(function(a){var b=a.data;b.status&&h({islogin:b.islogin,account:b.account,user:b.user}),c.resolve(a)}).catch(function(a){c.reject(a)}),d},k=function(c){var d=e(c),f=a.defer(),g=f.promise,h={method:"post",url:"/user/update",data:d,headers:{"Content-Type":void 0}};return b(h).then(function(a){f.resolve(a)}),g},l=function(c){var e=a.defer(),f=e.promise,g={method:"post",url:"/user/login",data:{user:c}};console.log("$location=",d);d.$$path.split("/")[2];return b(g).then(function(a){e.resolve(a)}),f},m=function(c){var d=a.defer(),e=d.promise,f={method:"post",url:"/user/register",data:{user:c}};return b(f).then(function(a){d.resolve(a)}),e},n=function(){var c=a.defer(),d=c.promise;return b.get("/user/logout").then(function(a){a.status?(f.islogin=!1,f.account="",c.resolve(a)):c.resolve(a)}).catch(function(a){c.reject()}),d},o=function(c){var d=a.defer(),e=d.promise,f={method:"get",url:"/user/setmsgreaded",params:{index:c}};return b(f).then(function(a){d.resolve(a)}),e},p=function(c,d){var e=a.defer(),f=e.promise,g={method:"get",url:"/user/addtomyfavor",params:{pollid:c,url:d}};return b(g).then(function(a){e.resolve(a)}),f},q=function(c){var d=a.defer(),e=d.promise,f={method:"get",url:"/user/deletefrommyfavor",params:{pollid:c}};return b(f).then(function(a){d.resolve(a)}),e};return{updateuser:k,setUserStatussync:h,getUserStatussync:g,signout:n,signup:m,signin:l,getUserStatus:i,getUserstatusfromdb:j,setmsgreaded:o,addtomyfavor:p,deletefrommyfavor:q}}]),polls1.directive("dragMe",["$drag",function(a){return{link:function(b,c){var d;a.bind(c,{transform:function(a,b,c){return d?(b.translateX=1*(d.translateX+c.distanceX),b.translateY=1*(d.translateY+c.distanceY)):(b.translateX=c.distanceX,b.translateY=c.distanceY),b},end:function(a){d=a.transform}})}}}]),angular.module("ngTouch",[]).directive("ngTouchstart",function(){return{controller:["$scope","$element",function(a,b){function c(c){var d=b.attr("ng-touchstart");a.$apply(d)}b.bind("touchstart",c)}]}}).directive("ngTouchmove",function(){return{controller:["$scope","$element",function(a,b){function c(a){a.preventDefault(),b.bind("touchmove",d),b.bind("touchend",e)}function d(c){var d=b.attr("ng-touchmove");a.$apply(d)}function e(a){a.preventDefault(),b.unbind("touchmove",d),b.unbind("touchend",e)}b.bind("touchstart",c)}]}}).directive("ngTouchend",function(){return{controller:["$scope","$element",function(a,b){function c(c){var d=b.attr("ng-touchend");a.$apply(d)}b.bind("touchend",c)}]}}),polls1.directive("chsheadimg",function(){return{replace:!0,scope:{user:"=u",dddds:"=headpicsrc"},templateUrl:"pages/templates/chsheadimg.html",link:function(a,b,c){var d=b[0].querySelector("img"),e=b[0].querySelector("input");d.onclick=function(a){e.click()},b.bind("change",function(b){function c(a,b){var c=new FileReader;c.onload=function(a){b.$apply(function(){d.src=a.target.result})},c.readAsDataURL(a.target.files[0])}a.user.headpic=e.files[0],c(b,a)})}}}),polls1.directive("backToTop",function(){return{restrict:"E",link:function(a,b,c){var d=b;d[0].onclick=function(a){console.log("sdfsaf")},d[0].onclick=function(){angular.element(document).find("body").animate({scrollTop:0},500)}}}}),polls1.directive("filefrominput",function(){return{replace:!0,scope:{fileread:"=",dddds:"=tpl",changeimgurl:"&ciu"},templateUrl:"pages/templates/filefrominput.html",link:function(a,b,c){var d=(b[0].querySelector("button"),b[0].querySelector("span")),e=b[0].querySelector("input"),f=b[0].querySelector("img");d.onclick=function(){console.log("hello!"),e.click()},b.bind("change",function(c){function d(a,b){var c=new FileReader;c.onload=function(a){f.src=a.target.result},c.readAsDataURL(a.target.files[0])}a.fileread.file=b[0].querySelector("input").files[0],d(c,a)})}}}).directive("multiimgup",function(){function a(a,b,c){a.name="Jeff";var d=b.find("img")[0],e=b.find("span"),f=b.find("input")[0];b.children()[0].onclick=function(a){f.click()},b.bind("change",function(b){function g(a){var b=new FileReader;b.onload=function(b){a.src=b.target.result},b.readAsDataURL(f.files[0])}var h=f.files[0];a.c[c.idx].file=h,h&&(e.css("display","none"),g(d))})}return{link:a,transclude:!0,scope:{index:"@idx",c:"=chos"},templateUrl:"pages/templates/mbchoiceimg.html"}}),polls1.service("messageService",["$rootScope",function(a){return{publish:function(b,c){a.$emit(b,c)},subscribe:function(b,c){a.$on(b,c)}}}]),polls1.directive("dragToDismiss",["$drag","$parse","$timeout","$transform",function(a,b,c,d){return{restrict:"A",compile:function(c,e){b(e.dragToDismiss);return function(b,c){var e,f=!1,g=!0;a.bind(c,{transform:function(a,b,f){return g&&(e=b,g=!1),f.distanceX>=-f.rect.width/4&&(f.distanceX<=0?(b.translateX=f.distanceX,b.translateY=0):d.set(c,e)),b},move:function(a){f=a.distanceX<=-a.rect.width/8},cancel:function(){c.removeClass("dismiss")},end:function(a){f?(a.transform.translateX=-a.rect.width/4,d.set(c,a.transform)):a.reset()}})}}}}]),polls1.controller("sidebarcontroller",["userservice","messageService","SharedState","$scope",function(a,b,c,d){b.subscribe("userlogin",function(a,b){d.islogin=b.islogin,d.account=b.account}),d.islogin=a.getUserStatussync().islogin,d.account=a.getUserStatussync().account}]),polls1.controller("myfavorcontroller",["$scope","SharedState","commentservice","messageService","userservice","socket","$location","$anchorScroll","$timeout",function(a,b,c,d,e,f,g,h,i){function j(){e.getUserstatusfromdb().then(function(b){a.user=b.data.user,a.islogin=b.data.islogin})}a.togglemyfavor=function(a){b.get("myfavor")==a?b.setOne("myfavor",-1):b.setOne("myfavor",a)},a.deletefavor=function(b){var c=b.poll;e.deletefrommyfavor(c).then(function(b){d.publish("userupdate",{user:b.user}),a.user=b.user,a.favor=!1})},a.gopolldetail=function(a){g.url(a.url)},j()}]),polls1.controller("msgController",["$scope","SharedState","commentservice","messageService","userservice","socket","$location","$anchorScroll","$timeout",function(a,b,c,d,e,f,g,h,i){function j(){e.getUserstatusfromdb().then(function(b){b.data.user&&(a.user=b.data.user,a.islogin=b.data.islogin)})}function k(b){e.setmsgreaded(b).then(function(b){console.log(b),a.user=b.data})}d.subscribe("userupdate",function(b,c){a.user=c.user}),d.subscribe("userlogin",function(b,c){a.user=c.user,a.islogin=c.islogin,j()}),f.on("newmsg",function(b){a.msgrem=!0,j()}),j(),a.tt=function(){console.log("sadfge")},a.gocommentdetail=function(a){var b=(/\/#\/(\w|\/|#)+/gim.exec(a.abturl)[0].split("/#")[1],/\/#\/(\w|\/|#)+/gim.exec(a.abturl)[0].split("/#")[1].split("#"));g.url(b[0]),i(function(){g.hash(b[1])},100)},a.toggle=function(c){b.get("myNotices")==c?b.setOne("myNotices",-1):b.setOne("myNotices",c),a.user.msgs[c].read||k(c)},a.deleteNotice=function(b){var d=a.user.msgs.indexOf(b);if(d>-1){var e=a.user.msgs.splice(d,1);console.log("deleted notice=",e),c.deleteusercomment(d).then(function(a){console.log("传回的数据是：",a.data)})}},a.testsockit=function(){},f.on("testobj",function(a){console.log("accountinfo是",a),alert("accountinfo是"+a)})}]),polls1.controller("UserController",["userservice","messageService","$scope","SharedState","pollservice","$location","commentservice","socket",function(a,b,c,d,e,f,g,h){function i(a){for(var b=!1,c=0,d=0,e=a.length;d<e;d++){var f=a[d];f.read||(b=!0,c++)}return{hasunread:b,num:c}}b.subscribe("userupdate",function(a,b){c.user=b.user}),h.on("newmsg",function(a){c.msgrem=!0,c.msgsnum=a}),c.islogin=a.getUserStatussync().islogin,c.islogin||a.getUserStatus().then(function(a){c.islogin=a.data.islogin,c.account=a.data.account,c.islogin&&(c.user=a.data.user,c.user.headpicsrc=c.user.img_Url?c.user.img_Url:e.getheadpic(),c.msgrem=i(c.user.msgs).hasunread,c.msgsnum=i(c.user.msgs).num,c.profilebg={background:"url("+c.user.headpicsrc+")","background-repeat":"no-repeat","background-size":"100% 100%"})}),c.mylatestmsg=function(){c.msgrem=!1,f.path("/mymsgs")},c.myfavor=function(){f.path("/myfavor")},c.updateuser=function(){console.log(c.user),a.updateuser(c.user).then(function(a){c.user=a.data,c.user.headpicsrc=c.user.img_Url,d.turnOff("modal15")})},c.zommout=function(a){console.log(a),c.img_zoom=!c.img_zoom},c.getheadpic=function(){c.user.headpicsrc=e.getheadpic()},c.presibling=function(a){var b=a.target.parentNode.nextSibling.nextSibling;b.click(),console.log(b)},c.login=function(){var d=c.user.account,e=c.user.password;c.error=!1,c.disabled=!0,a.signin({account:d,password:e}).then(function(e){var f=e.data;"ok"==f.status?(c.user=f.user,c.user.headpicsrc=f.user.img_Url,c.islogin=!0,a.setUserStatussync({islogin:!0,account:d}),b.publish("userlogin",{account:d,islogin:!0,user:f.user})):"wrongpass"==f.status?(c.islogin=!1,c.msg="Invalid username and/or password. 用户名/密码不对",a.setUserStatussync({islogin:!1,account:""})):"notexist"==f.status&&(c.islogin=!1,c.msg="User "+d+" does not exist. 用户"+d+"不存在",a.setUserStatussync({islogin:!1,account:""}))}).catch(function(){c.error=!0,c.msg="Invalid username and/or password",c.disabled=!1,c.user={}})},c.logout=function(){a.signout().then(function(a){var d=a.data;d.status&&(c.islogin=!1,c.user={},b.publish("userlogin",{account:"",islogin:!1}))})},c.register=function(){c.error=!1,c.disabled=!0;var d=c.user.account,f=c.user.password,g=e.getheadpic();a.signup({account:d,password:f,img_Url:g}).then(function(b){var e=b.data;return"ok"==e.status?c.autologin?a.signin({account:d,password:f}):{data:"tologin"}:"exist"==e.status?(console.log("result.status =='exist'"),{data:"exist"}):void 0}).then(function(e){var f=e.data;"ok"==f.status?(c.user=f.user,c.user.headpicsrc=f.user.img_Url,c.islogin=!0,a.setUserStatussync({islogin:!0,account:d}),b.publish("userlogin",{account:d,islogin:!0,user:f.user}),console.log("emituserlogin")):"wrongpass"==f.status?c.msg="Password not matched. 密码不对":"exist"==f?(console.log("result == 'exist'"),c.msg='User "'+d+'" alrady exist! 用户 '+d+" 已存在"):"tologin"==f&&(c.loginswitch=!0)}).catch(function(){c.error=!0,c.msg="Something went wrong!",c.disabled=!1})}}]);