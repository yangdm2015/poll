/*! bae-nodejs 09-03-2017 */
var polls1=angular.module("polls",["ngRoute"]).config(["$routeProvider",function(a){a.when("/polls",{templateUrl:"public/partials/list.html",controller:"PollListCtrl",access:{restricted:!1}}).when("/mypolls",{templateUrl:"public/partials/list.html",controller:"MyPollListCtrl",access:{restricted:!1}}).when("/myvotes",{templateUrl:"public/partials/list.html",controller:"MyVoteListCtrl",access:{restricted:!1}}).when("/poll/:pollId",{templateUrl:"public/partials/item.html",controller:"PollItemCtrl",access:{restricted:!1}}).when("/new",{templateUrl:"public/partials/new.html",controller:"PollNewCtrl",access:{restricted:!1}}).when("/login",{templateUrl:"public/partials/login.html",controller:"UserCtrl",access:{restricted:!1}}).when("/register",{templateUrl:"public/partials/register.html",controller:"UserCtrl",access:{restricted:!1}}).otherwise({redirectTo:"/polls"})}]);polls1.run(function(a,b,c,d){a.$on("$routeChangeStart",function(a,e,f){d.getUserStatus().then(function(a){null!=e.access&&e.access.restricted&&!a.islogin&&(console.log("reload!!!!!!!!!!!!!!"),b.path("/login"),c.reload())})})}),polls1.controller("HomeCtrl",["$timeout","$scope","$location","$route","userservice",function(a,b,c,d,e){e.getUserStatus().then(function(a){b.islogin=a.islogin,b.currusername=a.account});b.$on("userchange",function(a,c){console.log("HomeCtrlHomeCtrlHomeCtrlHomeCtrl"),c.test?console.log(c.t):(b.islogin=c.islogin,b.currusername=c.account)}),b.$on("test",function(a,b){console.log("test=",b.name)})}]),polls1.controller("MyPollListCtrl",["$timeout","$scope","$location","$route","pollservice","userservice",function(a,b,c,d,e,f){f.getUserStatus().then(function(a){var b=a.account;return e.getmypoll(b)}).then(function(a){b.polls=a})}]),polls1.controller("MyVoteListCtrl",["$timeout","$scope","$location","$route","pollservice","userservice",function(a,b,c,d,e,f){f.getUserStatus().then(function(a){var b=a.account;return e.getmyvote(b)}).then(function(a){b.polls=a})}]),polls1.controller("PollListCtrl",["$timeout","$scope","$location","$route","pollservice","userservice",function(a,b,c,d,e){console.log("PollListCtrl"),b.showItemdetail=function(a){return window.location.href="#/poll/"+a,!1},e.getallpolls().then(function(a){b.polls=a;for(var c in b.polls){var d=b.polls[c],e=new Date(d.meta.updateAt);e=(e.getTime()+"").slice(0,7),b.polls[c].order=e}})}]),polls1.controller("PollItemCtrl",function(a,b,c,d,e){c.getpoll(b.pollId).then(function(b){a.poll=b,a.poll.userVote=[],console.log("poll="+a.poll),a.overvoted=!1});var f=function(b,c){if("add"==b&&a.poll.userVote.indexOf(c)==-1&&(a.poll.userVote.push(c),a.poll.max_chosen_num<a.poll.userVote.length&&(a.overvoted=!0)),"remove"==b&&a.poll.userVote.indexOf(c)!=-1){var d=a.poll.userVote.indexOf(c);a.poll.userVote.splice(d,1),a.poll.max_chosen_num>=a.poll.userVote.length&&(a.overvoted=!1)}};a.updateSelection=function(b,c){var d=b.target,e=d.checked?"add":"remove";a.poll.allow_muti_choice&&f(e,c)},a.vote=function(){console.log("PollItemCtrl.vote"),e.getUserStatus().then(function(b){if(b.islogin){var c=a.poll._id,e=a.poll.allow_muti_choice?a.poll.userVote:[a.poll.nobodycares];if(useraccount=b.account,poll=a.poll,poll.userVote.length<=poll.max_chosen_num)if(e){var f={poll_id:c,choices:e,useraccount:useraccount};d.emit("send:vote",f)}else alert("You must select an option to vote for.你必须至少选择一项。");else alert("You can vote for no more than "+poll.max_chosen_num+" options.你最多只能选择 "+poll.max_chosen_num+" 个选项")}else alert("You must login before voting.你必须登陆才能投票。")})},a.$on("userchange",function(b,c){console.log("PollItemCtrlPollItemCtrlPollItemCtrl"),a.islogin=c.islogin,a.currusername=c.account}),d.on("vote",function(c){c._id===b.pollId&&(a.poll.choices=c.choices,a.poll.totalVotes=c.totalVotes,a.poll.totalVotedpeople=c.totalVotedpeople,a.poll.userVoted=!0,a.poll.userChoice=c.userChoice)})}),polls1.controller("PollNewCtrl",["$scope","$location","userservice","pollservice",function(a,b,c,d){console.log("PollNewCtrl"),a.poll={question:"",max_chosen_num:2,allow_muti_choice:!1,choices:[{text:""},{text:""}]},console.dir(a.poll),a.addChoice=function(){a.poll.choices.push({text:""}),a.choicenum.push(a.poll.choices.length)},a.popChoice=function(){a.poll.choices.pop(),a.choicenum.pop()},a.createPoll=function(){console.log("createPoll");var e=a.poll;c.getUserStatus().then(function(a){return e.created_user=a.account,d.savepoll(e)}).then(function(a){console.log("result=",a),b.path("polls")})}}]),polls1.controller("UserCtrl",["$scope","$http","userservice","$location",function(a,b,c,d){a.test="test",a.login=function(){var b=a.user.account,e=a.user.password;a.error=!1,a.disabled=!0,c.signin({account:b,password:e}).then(function(c){"ok"==c.status?(a.$emit("userchange",{islogin:!0,account:a.user.account}),d.path("/"),a.islogin=!0,a.currusername=a.user.account):"wrongpass"==c.status?(a.islogin=!1,a.msg="Invalid username and/or password. 用户名/密码不对"):"notexist"==c.status&&(a.islogin=!1,a.msg="User "+b+" does not exist. 用户"+b+"不存在")}).catch(function(){a.error=!0,a.msg="Invalid username and/or password",a.disabled=!1,a.user={}})},a.logout=function(){c.signout().then(function(b){b.status&&(a.$emit("userchange",{islogin:!1,account:""}),a.islogin=!1,a.currusername="")})};var e=0;a.tt=function(){var b="dd",d="rere";c.signup({account:b,password:d}).then(function(a){if("exist"==a.status)return c.signin({account:b,password:d})}).then(function(b){"wrongpass"==b.status&&a.$emit("userchange",{islogin:!0,test:!0,t:e})})},a.register=function(){a.error=!1,a.disabled=!0;var b=a.user.account,f=a.user.password;c.signup({account:b,password:f}).then(function(d){return"ok"==d.status?a.autologin?c.signin({account:b,password:f}):"tologin":"exist"==d.status?"exist":void 0}).then(function(c){"ok"==c.status?(e+=1,a.$emit("userchange",{islogin:!0,account:b}),console.log("emituserchange"),d.path("/")):"wrongpass"==c.status?(a.msg="Password not matched. 密码不对",d.path("/login"),a.disabled=!1):"exist"==c?(e+=1,console.log("emituserchange test:true,t=",e),a.msg='User "'+b+'" alrady exist! 用户 '+b+" 已存在"):"tologin"==c&&d.path("/login")}).catch(function(){a.error=!0,a.msg="Something went wrong!",a.disabled=!1})}}]),polls1.factory("userservice",["$q","$http",function(a,b){var c={islogin:!1,account:""},d=function(){var c=a.defer(),d=c.promise;return b.get("/user/status").success(function(a){c.resolve(a)}).error(function(a){c.reject(a)}),d},e=function(c){var d=a.defer(),e=d.promise,f={method:"post",url:"/user/login",data:{user:c}};return b(f).success(function(a){d.resolve(a)}),e},f=function(c){var d=a.defer(),e=d.promise,f={method:"post",url:"/user/register",data:{user:c}};return b(f).success(function(a){d.resolve(a)}),e},g=function(){var d=a.defer(),e=d.promise;return b.get("/user/logout").success(function(a){a.status?(c.islogin=!1,c.name="",d.resolve(a)):d.resolve(a)}).error(function(a){d.reject()}),e};return{signout:g,signup:f,signin:e,getUserStatus:d}}]),polls1.factory("pollservice",["$q","$http",function(a,b){var c=function(){var c=a.defer(),d=c.promise;return b.get("/polls/polls").success(function(a){c.resolve(a)}).error(function(a){c.reject(a)}),d},d=function(c){var d=a.defer(),e=d.promise;return b.get("/polls/"+c).success(function(a){d.resolve(a)}).error(function(a){d.reject(a)}),e},e=function(c){var d=a.defer(),e=d.promise;if(c.question.length>0){for(var f=0,g=0,h=c.choices.length;g<h;g++){var i=c.choices[g];i.text.length>0&&f++}if(f>1){var j={method:"post",url:"polls",data:{poll:c}};b(j).success(function(a){console.log("save successful"),d.resolve(a)}).error(function(a){d.reject(a),alert("暂时不能创建投票，请稍后再试")})}else alert("你必须至少填写两个选项！")}else alert("你必须填写投票主题！");return e},f=function(c){var d=a.defer(),e=d.promise;if(c){var f="/mypolls/"+c;b.get(f).success(function(a){console.log("in getmypoll, return data=",a),d.resolve(a)}).error(function(a){d.reject(a)})}else d.reject("Please login first!");return e},g=function(c){var d=a.defer(),e=d.promise;if(c){var f="/myvotes/"+c;b.get(f).success(function(a){d.resolve(a)}).error(function(a){d.reject(a)})}else d.reject("Please login first!");return e};return{getmypoll:f,getmyvote:g,getpoll:d,getallpolls:c,savepoll:e}}]).factory("socket",function(a,b){var c=io.connect();return{on:function(a,d){c.on(a,function(){var a=arguments;b(function(){d.apply(c,a)},0)})},emit:function(a,d,e){c.emit(a,d,function(){var a=arguments;b(function(){e&&e.apply(c,a)},0)})}}});