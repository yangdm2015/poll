/*! bae-nodejs 09-03-2017 */
polls1.controller("HomeCtrl",["$timeout","$scope","$location","$route","userservice",function(a,b,c,d,e){e.getUserStatus().then(function(a){b.islogin=a.islogin,b.currusername=a.account});b.$on("userchange",function(a,c){console.log("HomeCtrlHomeCtrlHomeCtrlHomeCtrl"),c.test?console.log(c.t):(b.islogin=c.islogin,b.currusername=c.account)}),b.$on("test",function(a,b){console.log("test=",b.name)})}]),polls1.controller("MyPollListCtrl",["$timeout","$scope","$location","$route","pollservice","userservice",function(a,b,c,d,e,f){f.getUserStatus().then(function(a){var b=a.account;return e.getmypoll(b)}).then(function(a){b.polls=a})}]),polls1.controller("MyVoteListCtrl",["$timeout","$scope","$location","$route","pollservice","userservice",function(a,b,c,d,e,f){f.getUserStatus().then(function(a){var b=a.account;return e.getmyvote(b)}).then(function(a){b.polls=a})}]),polls1.controller("PollListCtrl",["$timeout","$scope","$location","$route","pollservice","userservice",function(a,b,c,d,e){console.log("PollListCtrl"),b.showItemdetail=function(a){return window.location.href="#/poll/"+a,!1},e.getallpolls().then(function(a){b.polls=a;for(var c in b.polls){var d=b.polls[c],e=new Date(d.meta.updateAt);e=(e.getTime()+"").slice(0,7),b.polls[c].order=e}})}]),polls1.controller("PollItemCtrl",function(a,b,c,d,e){c.getpoll(b.pollId).then(function(b){a.poll=b,a.poll.userVote=[],console.log("poll="+a.poll),a.overvoted=!1});var f=function(b,c){if("add"==b&&a.poll.userVote.indexOf(c)==-1&&(a.poll.userVote.push(c),a.poll.max_chosen_num<a.poll.userVote.length&&(a.overvoted=!0)),"remove"==b&&a.poll.userVote.indexOf(c)!=-1){var d=a.poll.userVote.indexOf(c);a.poll.userVote.splice(d,1),a.poll.max_chosen_num>=a.poll.userVote.length&&(a.overvoted=!1)}};a.updateSelection=function(b,c){var d=b.target,e=d.checked?"add":"remove";a.poll.allow_muti_choice&&f(e,c)},a.vote=function(){console.log("PollItemCtrl.vote"),e.getUserStatus().then(function(b){if(b.islogin){var c=a.poll._id,e=a.poll.allow_muti_choice?a.poll.userVote:[a.poll.nobodycares];if(useraccount=b.account,poll=a.poll,poll.userVote.length<=poll.max_chosen_num)if(e){var f={poll_id:c,choices:e,useraccount:useraccount};d.emit("send:vote",f)}else alert("You must select an option to vote for.你必须至少选择一项。");else alert("You can vote for no more than "+poll.max_chosen_num+" options.你最多只能选择 "+poll.max_chosen_num+" 个选项")}else alert("You must login before voting.你必须登陆才能投票。")})},a.$on("userchange",function(b,c){console.log("PollItemCtrlPollItemCtrlPollItemCtrl"),a.islogin=c.islogin,a.currusername=c.account}),d.on("vote",function(c){c._id===b.pollId&&(a.poll.choices=c.choices,a.poll.totalVotes=c.totalVotes,a.poll.totalVotedpeople=c.totalVotedpeople,a.poll.userVoted=!0,a.poll.userChoice=c.userChoice)})}),polls1.controller("PollNewCtrl",["$scope","$location","userservice","pollservice",function(a,b,c,d){console.log("PollNewCtrl"),a.poll={question:"",max_chosen_num:2,allow_muti_choice:!1,choices:[{text:""},{text:""}]},console.dir(a.poll),a.addChoice=function(){a.poll.choices.push({text:""}),a.choicenum.push(a.poll.choices.length)},a.popChoice=function(){a.poll.choices.pop(),a.choicenum.pop()},a.createPoll=function(){console.log("createPoll");var e=a.poll;c.getUserStatus().then(function(a){return e.created_user=a.account,d.savepoll(e)}).then(function(a){console.log("result=",a),b.path("polls")})}}]);